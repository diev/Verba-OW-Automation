# Справочники открытых ключей и ключей, подготовленных для хранения на ЖМД

Важно: никаких секретных ключей на ЖМД не хранится, все секретные ключи 
остаются на своих носителях, никаких виртуальных дисков. 
В результате описанной здесь подготовительной работы штатными средствами 
АРМ РМП создается справочник, пригодный для использования скриптами, 
а сами носители, после загрузки с них всех ключей в память драйвера 
штатной утилитой ```asrkeyw```, убираются обратно в место хранения.

## Система именования ключей

Здесь и далее в записи идентификатора ключа вида XXXXSSSSSS[YY]:

* XXXX - номер клиента в сети (серии), 4 цифры;
* SSSSSS - сеть (серия), объединяющая разных клиентов, 6 цифр;
* YY - личный номер участника клиента - есть только у ключей ЭП (КА), 2 цифры.

## Порядок загрузки ключей

Ключи бывают как совмещенные (ЭП + шифрование), так и те, где только 
одна функция (другая при загрузке такого ключа становится недоступной). 
Поэтому для скриптов важно, чтобы первым в драйвер с помощью asrkeyw 
всегда загружался именно совмещенный ключ! Далее можно "Загрузить" любые 
другие (максимум 16). Важно знать, что нажимать "Выгрузить" затем поштучно 
не следует во избежание ошибок с имитовставками - только "Выгрузить все" 
и загрузить нужные заново.

АРМ РМП всегда (в настройке по умолчанию) работает с одним ключом, очищая 
память драйвера. Поэтому после АРМ РМП надо перезагрузить все ключи с 
помощью asrkeyw заново.

## Структура справочников АРМ РМП по умолчанию

Первым делом создайте все справочники с настройками по умолчанию, как 
предлагает АРМ РМП при загрузке каждого нового ключа.
Проделайте это для всех имеющихся ключей, загрузите с дискет полученные 
справочники открытых ключей других абонентов согласно документации.
 
При этом для каждого ключа будут созданы отдельные папки в 
"%APPDATA%\MDPREI\РМП Верба-OW\Настройка для ключа XXXX-SSSSSS[-YY]", 
в каждой из которых есть (одна или обе) папки:

* FAXKEY - справочник открытых ключей ЭП (КА);
  * SSSSSS - серия;
    * LFAX.SPR - сам справочник;
    * XXXXYY.IMM - файл(ы) имитовставки для защиты.
* OPENKEY - справочник открытых ключей шифрования;
  * SSSSSS - серия;
    * LPUB.SPR - сам справочник;
    * XXXX.IMP - файл(ы) имитовставки для защиты.

Также туда по умолчанию скопированы ключи, подготовленные для хранения 
на ЖМД (из папок HD1 на ключевых дискетах):

* XXXXYY.HSG - для ключей ЭП (КА);
* KS_XXXX и SEC_XXXX.KEY - для ключей шифрования.

Создайте теперь новую папку для нового общего справочника с более коротким 
путем (например, ```C:\Pub``` - назовем ее корневой) и экспортируйте туда 
все открытые ключи из справочников каждого ключа:

* Кнопка "Справочники" - закладка "Справочники открытых ключей";
* Выделить любой узел - правой кнопкой - "Экспорт всех ключей из всех 
справочников" - указать корневую папку.

## Отличие общего справочника от отдельных

Справочники АРМ РМП по умолчанию располагаются каждый в отдельной папке и 
пригодны для отдельного независимого использования со вставкой своего ключа 
каждый раз.

Для скриптов же создается общий справочник, для которого не требуется 
переставлять ключи для каждой операции. Единственное отличие - общий 
справочник, используемый разными ключами, должен быть подписан для 
защиты от изменений имитовставками каждого из этих ключей, и целостность 
этого проверяется.

## Ключи, подготовленные для хранения на ЖМД

По умолчанию функции библиотеки используют папку A:\HD1, но рекомендуется 
эти ключи, подготовленные штатным образом специально для хранения на ЖМД 
(а при использовании токенов это вообще единственная возможность), 
скопировать для работы в корневую папку, разложив по соответствующим папкам 
их серий SSSSSS, которые надо создать вручную. 
Затем скопировать туда файлы из папок по умолчанию в %APPDATA% или из папок 
HD1 на носителях. 

## Подготовка нового общего справочника

Запустить АРМ РМП с совмещенным ключом (настройка по умолчанию уже была 
проделана, все ключи экспортированы) и выполнить:

* Настройки - Создать новый справочник открытых ключей... - ЭП;
  * Указать, куда - в корневую папку;
  * Указать, откуда добавить открытые ключи ЭП (.lfx) - ```A:\HD1```;
* Настройки - Создать новый справочник открытых ключей... - Шифрования;
  * Указать, куда - в корневую папку;
  * Указать, откуда добавить открытые ключи шифрования (.pub) - ```A:\HD1```;
* Настройки - Каталог СКЗИ... - Каталог с секретным ключом шифрования;
  * Указать корневую папку;
* Настройки - Каталог СКЗИ... - Каталог с секретным ключом подписи;
  * Указать корневую папку;
* Настройки - Добавить открытый ключ в справочник... - ЭП;
  * Выделить все экспортированные ранее файлы .lfx и добавить 
(возможны разные сообщения, что уже есть и т.п.)
* Настройки - Добавить открытый ключ в справочник... - Шифрования;
  * Выделить все экспортированные ранее файлы .pub и добавить 
(возможны разные сообщения, что уже есть и т.п.)

Временную папку с экспортированными ключами теперь можно удалить.

## Подписывание общего справочника другими ключами

Запустить АРМ РМП с каждым из других ключей и выполнить указание корневой 
папки сначала для открытых ключей, а потом для закрытых, отвечая "Да" на 
каждый вопрос "Подписать весь справочник?":

* Настройки - Каталог СКЗИ... - Каталог с открытыми ключами подписи;
* Настройки - Каталог СКЗИ... - Каталог с открытыми ключами шифрования;
* Настройки - Каталог СКЗИ... - Каталог с секретным ключом шифрования;
* Настройки - Каталог СКЗИ... - Каталог с секретным ключом подписи.
                                                         
## Переподписывание общего справочника позже

Позже, если в справочнике происходят какие-либо изменения (добавление или 
удаление открытого ключа) или скрипты при работе выдают ошибку 111 
("Неверная имитовставка"), то общий справочник надо переподписать каждым 
ключом - зайти в АРМ РМП с ним и ответить "Да" на соответствующий вопрос.
